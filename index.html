<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - CORPORACI&Oacute;N DEMIVEN 2020, C.A.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>
    <style>
        :root {
            --primary-color: #1e3a8a; /* Azul oscuro */
            --secondary-color: #f59e0b; /* Ámbar/Oro */
            --background-color: #f1f5f9; /* Gris claro */
            --card-background: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #1c347d;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #d97706;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .toast-notification {
            animation: fadeInOut 4s ease-in-out forwards;
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Encabezado -->
        <header class="mb-8 p-4 bg-white rounded-lg shadow-md flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">CORPORACI&Oacute;N DEMIVEN 2020, C.A.</h1>
                <p class="text-sm text-gray-500">Sistema de Control de Inventario y Almac&eacute;n</p>
            </div>
            <div class="flex items-center gap-2">
                 <button id="exportDataBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span class="hidden md:inline">Exportar</span>
                </button>
                <button id="addNewItemBtn" class="btn-primary font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span class="hidden md:inline">Nuevo &Iacute;tem</span>
                </button>
            </div>
        </header>

        <!-- Contenido Principal: Inventario -->
        <main id="inventory-view" class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 border-b">
                <h2 class="text-xl font-bold">Inventario de Almac&eacute;n</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">C&oacute;digo</th>
                            <th scope="col" class="px-6 py-3">Descripci&oacute;n</th>
                            <th scope="col" class="px-6 py-3 text-center">Stock Actual</th>
                            <th scope="col" class="px-6 py-3">Unidad</th>
                            <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        <!-- Filas de inventario se insertarán aquí dinámicamente -->
                    </tbody>
                </table>
                 <div id="empty-state" class="hidden text-center p-12">
                    <i data-lucide="archive" class="w-16 h-16 mx-auto text-gray-300"></i>
                    <h3 class="mt-4 text-lg font-semibold text-gray-700">El inventario est&aacute; vac&iacute;o</h3>
                    <p class="mt-1 text-sm text-gray-500">Comienza agregando un nuevo &iacute;tem al almac&eacute;n.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Añadir/Editar Ítem -->
    <div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal" id="item-modal-content">
            <form id="item-form" class="p-6">
                <input type="hidden" id="item-id">
                <h2 id="modal-title" class="text-2xl font-bold mb-4">A&ntilde;adir Nuevo &Iacute;tem</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="item-code" class="block text-sm font-medium text-gray-700">C&oacute;digo</label>
                        <input type="text" id="item-code" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    </div>
                     <div>
                        <label for="item-unit" class="block text-sm font-medium text-gray-700">Unidad de Medida</label>
                        <input type="text" id="item-unit" placeholder="Ej: Pza, Kg, Lt, M" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="item-description" class="block text-sm font-medium text-gray-700">Descripci&oacute;n</label>
                    <textarea id="item-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="item-quantity" class="block text-sm font-medium text-gray-700">Cantidad Inicial</label>
                        <input type="number" id="item-quantity" min="0" step="any" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="item-reorder-point" class="block text-sm font-medium text-gray-700">Punto de Reorden</label>
                        <input type="number" id="item-reorder-point" min="0" step="any" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-item-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary font-bold py-2 px-4 rounded-lg">Guardar &Iacute;tem</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Entradas/Salidas -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal" id="transaction-modal-content">
            <form id="transaction-form" class="p-6">
                <input type="hidden" id="transaction-item-id">
                <input type="hidden" id="transaction-type">
                <h2 id="transaction-modal-title" class="text-2xl font-bold mb-2"></h2>
                <p class="mb-4 text-gray-600" id="transaction-item-name"></p>

                <div class="mb-4">
                    <label for="transaction-quantity" class="block text-sm font-medium text-gray-700">Cantidad</label>
                    <input type="number" id="transaction-quantity" min="0.01" step="any" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                </div>
                
                <div id="transaction-fields-salida" class="hidden space-y-4">
                     <div>
                        <label for="transaction-requester" class="block text-sm font-medium text-gray-700">Solicitante</label>
                        <input type="text" id="transaction-requester" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="transaction-department" class="block text-sm font-medium text-gray-700">Departamento/Frente</label>
                        <input type="text" id="transaction-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                
                <div id="transaction-fields-entrada" class="hidden">
                    <div>
                        <label for="transaction-reference" class="block text-sm font-medium text-gray-700">Referencia (N&deg; Factura/Gu&iacute;a)</label>
                        <input type="text" id="transaction-reference" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>

                <div class="mt-6 mb-4">
                    <label for="transaction-approver" class="block text-sm font-medium text-gray-700">Autorizado por</label>
                    <input type="text" id="transaction-approver" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-transaction-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="font-bold py-2 px-4 rounded-lg" id="confirm-transaction-btn">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Exportar Datos -->
    <div id="export-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal" id="export-modal-content">
            <div class="p-6">
                 <h2 class="text-2xl font-bold mb-4">Exportar Datos del Inventario</h2>
                 <p class="text-sm text-gray-600 mb-4">
                    Para actualizar el archivo de datos inicial, sigue estos pasos:<br>
                    1. Haz clic en "Copiar".<br>
                    2. Abre el archivo <strong>inventario_data.js</strong> en un editor de texto.<br>
                    3. Borra todo el contenido y pega estos nuevos datos. Guarda el archivo.
                 </p>
                 <textarea id="export-data-textarea" readonly class="w-full h-64 p-2 border rounded-md font-mono text-xs bg-gray-50"></textarea>
                 <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-export-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg">Cerrar</button>
                    <button type="button" id="copy-export-btn" class="btn-primary font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="clipboard-copy" class="w-5 h-5"></i>
                        Copiar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg hidden toast-notification">
        <p id="toast-message"></p>
    </div>

    <!-- Datos iniciales -->
    <script src="inventario_data.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar desde localStorage o datos iniciales
            let inventory = JSON.parse(localStorage.getItem('demivenInventory')) || (typeof initialDepartmentInventory !== 'undefined' ? initialDepartmentInventory : []);

            const inventoryTableBody = document.getElementById('inventory-table-body');
            const emptyState = document.getElementById('empty-state');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            const saveInventory = () => {
                localStorage.setItem('demivenInventory', JSON.stringify(inventory));
            };
            
            const showToast = (message, isError = false) => {
                toastMessage.innerHTML = message; 
                toast.classList.remove('hidden');
                toast.classList.toggle('bg-red-600', isError);
                toast.classList.toggle('bg-gray-800', !isError);
                setTimeout(() => toast.classList.add('hidden'), 4000);
            };

            const renderInventory = () => {
                inventoryTableBody.innerHTML = '';
                if (inventory.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }

                inventory.sort((a, b) => a.code.localeCompare(b.code)).forEach(item => {
                    const lowStock = item.reorderPoint && item.quantity <= item.reorderPoint;
                    const row = document.createElement('tr');
                    row.className = `bg-white border-b ${lowStock ? 'bg-amber-50' : ''}`;
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap text-xs md:text-sm">${item.code}</td>
                        <td class="px-6 py-4">
                            <div class="font-semibold text-xs md:text-sm">${item.description}</div>
                            ${lowStock ? `<div class="text-[10px] text-red-600 font-bold">STOCK BAJO</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-center font-mono text-sm md:text-lg">${parseFloat(item.quantity).toLocaleString('es-VE')}</td>
                        <td class="px-6 py-4 text-xs md:text-sm">${item.unit}</td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col md:flex-row justify-center items-center gap-2">
                                <div class="flex gap-2">
                                    <button data-id="${item.id}" class="btn-entrada bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-md text-[10px]">Entrada</button>
                                    <button data-id="${item.id}" class="btn-salida bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-md text-[10px]">Salida</button>
                                </div>
                                <div class="flex gap-3 mt-1 md:mt-0">
                                    <button data-id="${item.id}" class="btn-editar text-blue-600 hover:text-blue-800 p-1" title="Editar">
                                        <i data-lucide="edit" class="w-5 h-5"></i>
                                    </button>
                                    <button data-id="${item.id}" class="btn-eliminar text-gray-400 hover:text-red-600 p-1" title="Eliminar">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        </td>
                    `;
                    inventoryTableBody.appendChild(row);
                });

                // RE-INICIALIZAR ICONOS DESPUÉS DE RENDERIZAR LA TABLA
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            };

            // --- LÓGICA DE MODALES Y FORMULARIOS (Igual a la versión anterior pero asegurando integración) ---
            const itemModal = document.getElementById('item-modal');
            const itemForm = document.getElementById('item-form');
            const transactionModal = document.getElementById('transaction-modal');
            const transactionForm = document.getElementById('transaction-form');

            const openItemModal = (item = null) => {
                itemForm.reset();
                if (item) {
                    document.getElementById('modal-title').innerHTML = 'Editar &Iacute;tem';
                    document.getElementById('item-id').value = item.id;
                    document.getElementById('item-code').value = item.code;
                    document.getElementById('item-description').value = item.description;
                    document.getElementById('item-quantity').value = item.quantity;
                    document.getElementById('item-quantity').disabled = true;
                    document.getElementById('item-unit').value = item.unit;
                    document.getElementById('item-reorder-point').value = item.reorderPoint || '';
                } else {
                    document.getElementById('modal-title').innerHTML = 'A&ntilde;adir Nuevo &Iacute;tem';
                    document.getElementById('item-id').value = '';
                    document.getElementById('item-quantity').disabled = false;
                }
                itemModal.classList.remove('hidden');
            };

            // Eventos de botones de la tabla
            inventoryTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const id = button.dataset.id;
                const item = inventory.find(i => i.id === id);
                
                if (button.classList.contains('btn-editar')) {
                    openItemModal(item);
                } else if (button.classList.contains('btn-eliminar')) {
                    if (confirm(`¿Eliminar permanentemente: ${item.code} - ${item.description}?`)) {
                        inventory = inventory.filter(i => i.id !== id);
                        saveInventory();
                        renderInventory();
                        showToast('&Iacute;tem eliminado.', true);
                    }
                } else if (button.classList.contains('btn-entrada')) {
                    // Lógica de modal de entrada...
                    document.getElementById('transaction-item-id').value = id;
                    document.getElementById('transaction-type').value = 'entrada';
                    document.getElementById('transaction-modal-title').innerText = 'Registrar Entrada';
                    document.getElementById('transaction-fields-entrada').classList.remove('hidden');
                    document.getElementById('transaction-fields-salida').classList.add('hidden');
                    transactionModal.classList.remove('hidden');
                } else if (button.classList.contains('btn-salida')) {
                    // Lógica de modal de salida...
                    document.getElementById('transaction-item-id').value = id;
                    document.getElementById('transaction-type').value = 'salida';
                    document.getElementById('transaction-modal-title').innerText = 'Nota de Entrega';
                    document.getElementById('transaction-fields-salida').classList.remove('hidden');
                    document.getElementById('transaction-fields-entrada').classList.add('hidden');
                    transactionModal.classList.remove('hidden');
                }
            });

            // Botón añadir nuevo
            document.getElementById('addNewItemBtn').onclick = () => openItemModal();
            document.getElementById('cancel-item-btn').onclick = () => itemModal.classList.add('hidden');
            document.getElementById('cancel-transaction-btn').onclick = () => transactionModal.classList.add('hidden');

            itemForm.onsubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('item-id').value;
                const code = document.getElementById('item-code').value.toUpperCase();
                
                if (id) {
                    const item = inventory.find(i => i.id === id);
                    item.code = code;
                    item.description = document.getElementById('item-description').value;
                    item.unit = document.getElementById('item-unit').value;
                    item.reorderPoint = parseFloat(document.getElementById('item-reorder-point').value);
                } else {
                    inventory.push({
                        id: 'ITEM-' + Date.now(),
                        code,
                        description: document.getElementById('item-description').value,
                        quantity: parseFloat(document.getElementById('item-quantity').value),
                        unit: document.getElementById('item-unit').value,
                        reorderPoint: parseFloat(document.getElementById('item-reorder-point').value)
                    });
                }
                saveInventory();
                renderInventory();
                itemModal.classList.add('hidden');
                showToast('Guardado con &eacute;xito.');
            };

            transactionForm.onsubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('transaction-item-id').value;
                const type = document.getElementById('transaction-type').value;
                const qty = parseFloat(document.getElementById('transaction-quantity').value);
                const item = inventory.find(i => i.id === id);

                if (type === 'salida' && qty > item.quantity) {
                    showToast('Stock insuficiente', true);
                    return;
                }

                item.quantity = type === 'entrada' ? item.quantity + qty : item.quantity - qty;
                saveInventory();
                renderInventory();
                transactionModal.classList.add('hidden');
                showToast('Operaci&oacute;n registrada.');
            };

            // Exportar
            document.getElementById('exportDataBtn').onclick = () => {
                const data = `const initialDepartmentInventory = ${JSON.stringify(inventory, null, 2)};`;
                document.getElementById('export-data-textarea').value = data;
                document.getElementById('export-modal').classList.remove('hidden');
            };
            document.getElementById('cancel-export-btn').onclick = () => document.getElementById('export-modal').classList.add('hidden');
            document.getElementById('copy-export-btn').onclick = () => {
                document.getElementById('export-data-textarea').select();
                document.execCommand('copy');
                showToast('Copiado al portapapeles');
            };

            renderInventory();
        });
    </script>
</body>
</html>
